{"version":3,"file":"markdownItTocDoneRight.mjs","sources":["../index.js"],"sourcesContent":["\n\nfunction slugify(x) {\n  return encodeURIComponent(String(x).trim().toLowerCase().replace(/\\s+/g, '-'));\n}\n\nfunction htmlencode(x) {\n/*\n  // safest, delegate task to native -- IMPORTANT: enabling this breaks both jest and runkit, but with browserify it's fine\n  if (document && document.createElement) {\n    const el = document.createElement(\"div\")\n    el.innerText = x\n    return el.innerHTML\n  }\n*/\n\n  return String(x)\n    .replace(/&/g, '&amp;')\n    .replace(/\"/g, '&quot;')\n    .replace(/'/g, '&#39;')\n    .replace(/</g, '&lt;')\n    .replace(/>/g, '&gt;');\n}\n\nfunction tocPlugin(md, options) {\n  options = Object.assign({}, {\n    placeholder: '(\\\\$\\\\{toc\\\\}|\\\\[\\\\[?_?toc_?\\\\]?\\\\]|\\\\$\\\\<toc(\\\\{[^}]*\\\\})\\\\>)',\n    slugify: slugify,\n    uniqueSlugStartIndex: 2,\n    containerClass: 'table-of-contents',\n    containerId: undefined,\n    listClass: undefined,\n    itemClass: undefined,\n    linkClass: undefined,\n    level: 6,                  // same as @gerhobbelt/markdown-it-anchor: **max** level or array of levels\n    listType: 'ol',\n    format: undefined,\n    callback: undefined/* function(html, ast, state) {} */\n  }, options);\n\n  let ast;\n  const pattern = new RegExp('^' + options.placeholder + '$', 'i');\n\n  function toc(state, startLine, endLine, silent) {\n    let token;\n    const pos = state.bMarks[startLine] + state.tShift[startLine];\n    const max = state.eMarks[startLine];\n\n    // use whitespace as a line tokenizer and extract the first token\n    // to test against the placeholder anchored pattern, rejecting if false\n    const lineFirstToken = state.src.slice(pos, max).split(' ')[0];\n    if (!pattern.test(lineFirstToken)) return false;\n\n    if (silent) return true;\n\n    const matches = pattern.exec(lineFirstToken);\n    let inlineOptions = {};\n    if (matches !== null && matches.length === 3) {\n      try {\n        inlineOptions = JSON.parse(matches[2]);\n      } catch (ex) {\n        // silently ignore inline options\n      }\n    }\n\n    state.line = startLine + 1;\n\n    token = state.push('tocOpen', 'nav', 1);\n    token.markup = '';\n    token.map = [ startLine, state.line ];\n    token.inlineOptions = inlineOptions;\n\n    token = state.push('tocBody', '', 0);\n    token.markup = '';\n    token.map = [ startLine, state.line ];\n    token.inlineOptions = inlineOptions;\n    token.children = [];\n\n    token = state.push('tocClose', 'nav', -1);\n    token.markup = '';\n\n    return true;\n  }\n\n  md.renderer.rules.tocOpen = function (tokens, idx/* , options, env, renderer */) {\n    const token = tokens[idx];\n    let _options = Object.assign({}, options, token.inlineOptions);\n    const id = _options.containerId ? ` id=\"${htmlencode(_options.containerId)}\"` : '';\n    return `<nav${id} class=\"${htmlencode(_options.containerClass)}\">`;\n  };\n\n  md.renderer.rules.tocClose = function (/* tokens, idx, options, env, renderer */) {\n    return '</nav>';\n  };\n\n  md.renderer.rules.tocBody = function (tokens, idx/* , options, env, renderer */) {\n    const token = tokens[idx];\n    let _options = Object.assign({}, options, token.inlineOptions);\n\n    const uniques = new Map();\n    function unique(slug, failOnNonUnique) {\n      // If first slug, return as is.\n      let key = slug;\n      let n = _options.uniqueSlugStartIndex;\n      while (uniques.has(key)) {\n        // Duplicate slug, add a `-2`, `-3`, etc. to keep ID unique.\n        key = `${slug}-${n++}`;\n      }\n\n      if (n > _options.uniqueSlugStartIndex && failOnNonUnique) {\n        throw new Error(`The ID attribute '${slug}' defined by user or other markdown-it plugin is not unique. Please fix it in your markdown to continue.`);\n      }\n\n      // Mark this slug as used in the environment.\n      uniques.set(key, true);\n      return key;\n    }\n\n    const isLevelSelectedNumber = selection => level => level <= selection;\n    const isLevelSelectedArray = selection => level => selection.includes(level);\n\n    const isLevelSelected = Array.isArray(_options.level)\n      ? isLevelSelectedArray(_options.level)\n      : isLevelSelectedNumber(_options.level);\n\n    function ast2html(tree, level) {\n      const listClass = _options.listClass ? ` class=\"${htmlencode(_options.listClass)}\"` : '';\n      const itemClass = _options.itemClass ? ` class=\"${htmlencode(_options.itemClass)}\"` : '';\n      const linkClass = _options.linkClass ? ` class=\"${htmlencode(_options.linkClass)}\"` : '';\n\n      if (tree.c.length === 0) return '';\n\n      let buffer = '';\n      if (tree.l === 0 || isLevelSelected(tree.l + 1)) {\n        buffer += `<${htmlencode(_options.listType) + listClass}>`;\n      }\n      tree.c.forEach(node => {\n        // first, check if the heading already has an ID attribute:\n        // if it has, use that one!\n        let slug = node.token.attrGet('id');\n        if (isLevelSelected(node.l)) {\n          if (slug == null) {\n            slug = unique(options.slugify(node.n), false);\n            // and register the ID for this heading,\n            // so it won't have to be re-generated by other plugins,\n            // resulting in consistent ID usage in the page:\n            node.token.attrSet('id', slug);\n          }\n          buffer += `<li${itemClass}><a${linkClass} href=\"#${slug}\">${typeof _options.format === 'function' ? _options.format(node.n, htmlencode) : htmlencode(node.n)}</a>${ast2html(node, node.l)}</li>`;\n        } else {\n          buffer += ast2html(node, level + 1);\n        }\n      });\n      if (tree.l === 0 || isLevelSelected(tree.l + 1)) {\n        buffer += `</${htmlencode(_options.listType)}>`;\n      }\n      return buffer;\n    }\n\n    tokens\n      .filter(token => token.type === 'heading_open')\n      .forEach(token => {\n        // Before we do anything, we must collect all previously defined ID attributes to ensure we won't generate any duplicates:\n        let slug = token.attrGet('id');\n\n        if (slug != null) {\n          // mark existing slug/ID as unique, at least.\n          // IFF it collides, FAIL!\n          unique(slug, true);\n        }\n      });\n\n    return ast2html(ast, 1);\n  };\n\n  function headings2ast(tokens) {\n    const ast = { l: 0, n: '', c: [] };\n    const stack = [ ast ];\n\n    for (let i = 0, iK = tokens.length; i < iK; i++) {\n      const token = tokens[i];\n      if (token.type === 'heading_open') {\n        let keyparts = [];\n        for (let j = i + 1; j < iK; j++) {\n          const token = tokens[j];\n          if (token.type === 'heading_close') { break; }\n          if (!token.children) { continue; }\n          const keypart = token.children\n          .filter((token) => token.type === 'text' || token.type === 'code_inline')\n          .reduce((acc, t) => acc + t.content, '')\n          .trim();\n          if (keypart.length > 0) {\n            keyparts.push(keypart);\n          }\n        }\n        const key = keyparts.join(' ');\n        const node = {\n          l: parseInt(token.tag.substr(1), 10),\n          n: key,\n          c: [],\n          token\n        };\n\n        if (node.l > stack[0].l) {\n          stack[0].c.push(node);\n          stack.unshift(node);\n        } else if (node.l === stack[0].l) {\n          stack[1].c.push(node);\n          stack[0] = node;\n        } else {\n          while (node.l <= stack[0].l) stack.shift();\n          stack[0].c.push(node);\n          stack.unshift(node);\n        }\n      }\n    }\n\n    return ast;\n  }\n\n  md.core.ruler.push('generateTocAst', function (state) {\n    const tokens = state.tokens;\n    ast = headings2ast(tokens);\n\n    if (typeof options.callback === 'function') {\n      for (let i = 0, iK = tokens.length; i < iK; i++) {\n        const token = tokens[i];\n        if (token.type === 'tocOpen') {\n          options.callback(\n            md.renderer.rules.tocOpen(tokens, i) + md.renderer.rules.tocBody(tokens, i) + md.renderer.rules.tocClose(),\n            ast,\n            state\n          );\n        }\n      }\n    }\n  });\n\n  md.block.ruler.before('heading', 'toc', toc, {\n    alt: [ 'paragraph', 'reference', 'blockquote' ]\n  });\n}\n\nexport default tocPlugin;\n"],"names":["slugify","x","encodeURIComponent","String","trim","toLowerCase","replace","htmlencode","tocPlugin","md","options","Object","assign","placeholder","uniqueSlugStartIndex","containerClass","containerId","undefined","listClass","itemClass","linkClass","level","listType","format","callback","ast","pattern","RegExp","toc","state","startLine","endLine","silent","token","pos","bMarks","tShift","max","eMarks","lineFirstToken","src","slice","split","test","matches","exec","inlineOptions","length","JSON","parse","ex","line","push","markup","map","children","renderer","rules","tocOpen","tokens","idx","_options","id","tocClose","tocBody","uniques","Map","unique","slug","failOnNonUnique","key","n","has","Error","set","isLevelSelectedNumber","selection","isLevelSelectedArray","includes","isLevelSelected","Array","isArray","ast2html","tree","c","buffer","l","forEach","node","attrGet","attrSet","filter","type","headings2ast","stack","i","iK","keyparts","j","keypart","reduce","acc","t","content","join","parseInt","tag","substr","unshift","shift","core","ruler","block","before","alt"],"mappings":"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"}